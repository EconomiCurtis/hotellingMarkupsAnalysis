---
title: "Hotelling Markups Initial Analysis"
author: "Curtis Kephart"
output:
  html_document:
    toc: yes
    toc_depth: 2
  html_notebook:
    toc: yes
    toc_depth: 2
  pdf_document: default
---
```{r, message = FALSE, warning = FALSE, echo = FALSE, error=FALSE, include=FALSE, cache=FALSE}
library(dplyr)
library(ggplot2)
library(knitr)
library(tidyr)
source("etl.r")
```



## Sandbox


-----

--**Dave**: One of the key hypotheses is that profits (mark-ups) will be less responsive in the 2p game (because of collusion). Could you compute the mean (and median) for each period for each pair (or group), i.e. average across all the rounds. For each of those periods observations we'll have a transport cost. What I'd like to do is log that data then run a regression of `ln(profit)= a0 + a1*ln(transport cost)+ (a2 * 2p) + (a3 * 2p * ln(transport cost))`, where 2p is a dummy for 2p periods. I think this is the correct equation.. Essentially, I want to estimate the elasticity of profits to transport costs and see if that is higher for 4p sessions. We should expect a1 to be positive and a3 to be negative, if my hypotheses are correct...--

```{r, message = FALSE, warning = FALSE, echo = FALSE, error=FALSE, cache=FALSE}


df =  sesDat2p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  mutate(
    player.round_payoff = player.round_payoff * max(subsession.round_number) #deal with f'ing t=0.25...
  ) %>%
  summarise(
    profit = mean(player.round_payoff),
    profit_median = median(player.round_payoff),
    twoPlayer = 1,
    playerNum = "Two Players"
  )

df = bind_rows(
  df, 
  sesDat4p %>%
    ungroup() %>%
    group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
    mutate(
      player.round_payoff = player.round_payoff * max(subsession.round_number) #deal with f'ing t=0.25...
    ) %>%
    summarise(
      profit = mean(player.round_payoff),
      profit_median = median(player.round_payoff),
      twoPlayer = 0,
      playerNum = "Four Players"
    )
) %>%
  dplyr::filter(
    player.transport_cost != 0.25
  ) %>%
  mutate(
    log_profit = log((profit + 0.01) * 10000),
    log_profit = ifelse(log_profit < 0, 0, log_profit)
  ) %>% 
  group_by(playerNum) %>%
  dplyr::mutate(
    sd_prof = sd(profit),
    stdz_profit = profit / sd_prof
  )
p1 = ggplot(
  df,
  aes(
    x = profit
  )
) +
  geom_histogram() +
  theme_bw() +
  labs(
    title = "Distribution of Profits",
    x = "Mean profit, Ss in one period over all sub-periods"
  )
p1
```

Above is the distribution of round profits. Where round profits is the mean profit of one subject in one period (at a fixed transport cost and number of counterparts).

However, we have a problem. Profit and transport costs are between 0 and 1. Log profit is not possible without omitting observations (introducing bias) or other manipulations.

I transform profit by adding an insignificant quantity (0.01) to all observations, and multiplying that by 10000. 

This produces the following distribution of observed profits;

```{r, message = FALSE, warning = FALSE, echo = FALSE, error=FALSE, cache=FALSE}

p1 = ggplot(
  df,
  aes(
    x = (profit + 0.01) * 1000
  )
) +
  geom_histogram() +
  theme_bw() +
    labs(
    title = "Distribution of Profits",
    subtitle = "Profit Transformation: `(profit + 0.01) * 10000`",
    x = "Mean profit, Ss in one period over all sub-periods"
  )
p1
```

With this transformation to profit, we have the following regression. 

```{r, message = FALSE, warning = FALSE, echo = FALSE, error=FALSE, cache=FALSE}


p1= ggplot(
  df,
  aes(
    x = player.transport_cost,
    y = log_profit,
    group = playerNum,
    color = playerNum
  )
) +
  geom_jitter(
    width = 0.07,
    alpha = .4) +
  geom_smooth(
    method = 'lm'
  ) +
  theme_bw()
p1



reg = lm(
  log_profit ~ log(player.transport_cost) + twoPlayer + twoPlayer:log(player.transport_cost),
  df
)

summary(reg)
```

With issues in transforming profit in mind, we have the above regression results. If we hadn't transformed profit and been able to run a regular log-log regression with your specification, we would interpret $\beta_3$ as "*the 2-player game, a one unit increase in transport cost decreases profit by 23% compared to the 4-player game*" (if my interpretation is correct).  


Additional regressions: 

#### Normalized Profit

```{r, message = FALSE, warning = FALSE, echo = FALSE, error=FALSE, cache=FALSE}


reg = lm(
  stdz_profit~ log(player.transport_cost) + twoPlayer + twoPlayer:log(player.transport_cost),
  df
)

summary(reg)
```

A regression with normalized profit is statistically significant, and has similar results as the price-transformed log-log.

Now we would interpret $\beta_3$ as "*the 2-player game, a one unit increase in transport cost decreases profit by 0.23 standard deviations compared to the 4-player game*" (if my interpretation is correct, that could probably be said better).  


#### Level - Log

```{r, message = FALSE, warning = FALSE, echo = FALSE, error=FALSE, cache=FALSE}


reg = lm(
  profit~ log(player.transport_cost) + twoPlayer + twoPlayer:log(player.transport_cost),
  df
)

summary(reg)
```


A Regular level-log regression has `player.transport_cost:twoPlayer` is insignificant. 


-----

--**Dave**: How did you measure collusion in your other Hotellings work? I'd like to know if "collusion" is higher in 2p sessions and, if it's higher in low transport cost periods, in both 2p and 4p. Looking at the second figure for 2p, it looks like the profits that are much higher than the bulk of the mass (which is suggestive of collusion), and this happens more frequently at low transport costs. You see the same sort of pattern in the second figure in 4p, but more less prevalent. Visually, it seems suggestive of these additional hypotheses.--

We had a few measures of collusion. Since we had a continuous time data, we looked at how subjects responded to others' action selection. E.g., (in the price and location Hotelling setting), when a player did change their action, did they move location and price in a way that opened up the possibility of getting higher joint profit (which usually meant reducing one's profit)? Or did they act "competitively", increasing own profit at expense of counterparty? As another measure of collusion, if there were joint positive profits, did players remain stationary? 

Collusion Metrics:

- In this setting, we might consider the direct and magnitude of price changes. Where changes in prices generally down? or up? This has problems since players colliding at very high prices don't have room to signal further collusion by increasing prices. 
- ... I don't have a good response to this...

Regarding your observation that looking at profit and transport costs, the very low transport cost treatments had lower than average profit, but had a few observations with very high profit. Isn't this more a "technical artifact" (probably not the right term...), where with `t = 0.1` if your opponent has high prices, a slightly lower price will seriously undercut them and capture a large portion of the market. Whereas with high transport cost, you need to be seriously below your opponent to undercut their price and capture serious market share. So, it would seem to me that there are a few cases with low transport costs where a "good" player was up against a careless one, and in that period the good player earned the rare, very high profit that period. 



# Two-Player Game

Sessions run so far, 

```{r, message = FALSE, warning = FALSE, echo = FALSE, error=FALSE}


# names(sesDat2p)
# unique(sesDat2p$session.code)
# df = sesDat2p %>%
#   group_by(session.code,player.period_number,player.transport_cost) %>%
#   summarise(
#     mean_profit = mean(player.round_payoff * 100),
#     player_count = length(unique(participant.code)),
#     avg_periods_perPlayer = length((player.period_number)),
#     round_count = length(unique(subsession.round_number))
#   )
# kable(
#   format = "markdown",
#   df,  align = c("c")
#   # col.names = c("","","","Avg Task 1 RET Score","Avg Task 2 RET Score","Avg Task 3 RET Score","Tourn", "Ss")
# )

df = sesDat2p %>%
  group_by(session.code) %>%
  summarise(
    n_subjects = length(unique(participant.code)),
    date = min(participant.time_started)
  )
kable(
  format = "markdown",
  df,  align = c("c")
  # col.names = c("","","","Avg Task 1 RET Score","Avg Task 2 RET Score","Avg Task 3 RET Score","Tourn", "Ss")
)



```


```{r, echo=FALSE, tidy=T}
#4 error check

# names(sesDat4p)
# unique(sesDat4p$session.code)
# df = sesDat4p %>%
#   group_by(session.code,player.period_number,player.transport_cost) %>%
#   summarise(
#     mean_profit = mean(player.round_payoff * 100),
#     player_count = length(unique(participant.code)),
#     round_count = length(unique(subsession.round_number))
#   )
# 
# kable(
#   format = "markdown", 
#   df,  align = c("c")
#   # col.names = c("","","","Avg Task 1 RET Score","Avg Task 2 RET Score","Avg Task 3 RET Score","Tourn", "Ss")
# )
```

```{r, echo=FALSE, tidy=T}
#4 error check

# names(sesDat4p)
# unique(sesDat4p$session.code)
# df = sesDat4p %>%
#   group_by(session.code,participant.code,player.period_number,player.transport_cost) %>%
#   summarise(
#     mean_profit = mean(player.round_payoff),
#     mean_profit2 = mean(player.round_payoff) * length(player.round_payoff),
#     sum_profit = sum(player.round_payoff),
#     player.cumulative_round_payoff = max(player.cumulative_round_payoff),
#     player_count = length(unique(participant.code)),
#     round_count = length(unique(subsession.round_number))
#   )

```



## Profit and Transport Costs

A fairly clear story here. The figure below plots average payoffs for each session. This averages payoffs over all subject in all periods within one session. 

```{r, echo=FALSE}
ggplot(
  sesDat2p %>%
    group_by(session.code,player.transport_cost,player.transport_cost) %>%
    summarise(
      mean_profit = mean(player.round_payoff * max(subsession.round_number))
    ) %>%
    filter(
      !is.na(mean_profit)
    )
) +
  geom_point(
    aes(
      x = as.factor(player.transport_cost),
      y = mean_profit,
      color = paste(session.code,player.transport_cost)
    )
  )
```

Note that the transport cost of 0.25 had an error in its implementation. In 0.25 transport cost periods, subjects only had 5 subperiods, not the 20 all other periods had. This most likely explains the odd result. 


In the table below I compare average payoff between transport cost treatments, at the session level.

The standard errors are probably not the way you want to do it. I'm using every observation from each subperiod of each period. We probably want to compare average payoffs per period or per session. But still...

```{r, echo = F, eval = T, tidy = T}
df = sesDat2p %>%
  ungroup() %>%
  group_by(player.transport_cost) %>%
  mutate(
    player.round_payoff = player.round_payoff * max(subsession.round_number) #deal with f'ing t=0.25...
  ) %>%
  summarise(
    n=n(),
    mean_profit = mean(player.round_payoff),  
    median_profit = median(player.round_payoff),
    se_profit = sd(player.round_payoff)/(n)^0.5
  ) 

kable(
  format = "markdown", 
  df,  align = c("c")
  # col.names = c("","","","Avg Task 1 RET Score","Avg Task 2 RET Score","Avg Task 3 RET Score","Tourn", "Ss")
)
```

Now, below, we calculate standard error with mean payoffs at the session+period+transport cost level. 

There are far fewer observations, making our standard error much larger. However, still, the very low transport cost are significantly different from the two transport costs in the high range. 

```{r, echo = F, eval = T, tidy = T}
df = sesDat2p %>%
  ungroup() %>%
  group_by(session.code, player.transport_cost, player.period_number) %>% 
  mutate(
    player.round_payoff = player.round_payoff * max(subsession.round_number) #deal with f'ing t=0.25...
  ) %>%
  summarise(
    n=n(),
    mean_profit = mean(player.round_payoff),  
    median_profit = median(player.round_payoff),
    se_profit = sd(player.round_payoff)/(n)^0.5
  ) %>%
  group_by(player.transport_cost) %>%
  summarise(
    n=n(),
    mean_profit_ = mean(mean_profit), 
    se_profit = sd(mean_profit)/(n)^0.5
  )

kable(
  format = "markdown", 
  df,  align = c("c")
  # col.names = c("","","","Avg Task 1 RET Score","Avg Task 2 RET Score","Avg Task 3 RET Score","Tourn", "Ss")
)
```



```{r, echo=FALSE}
ggplot(
 sesDat2p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  mutate(
    player.round_payoff = player.round_payoff * max(subsession.round_number) #deal with f'ing t=0.25...
  ) %>%
   summarise(
     mean_profit = mean(player.round_payoff)
   )
) +
    geom_violin(
    aes(
      x = as.factor(player.transport_cost),
      y = mean_profit
    ), alpha = .8
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.transport_cost),
      y = mean_profit,
      color = player.period_number
    ), 
    alpha = .7,
    width = .1, height = 0
  ) +
  theme_bw()
```

Looking at distributions in another way, 

```{r, echo=FALSE, fig.height=3.5, fig.width=8}
ggplot(
 sesDat2p %>%
  ungroup() %>%
    filter(
      !is.na(player.round_payoff),
      player.transport_cost != 0.25
    ) %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  mutate(
    player.round_payoff = player.round_payoff * max(subsession.round_number) #deal with f'ing t=0.25...
  ) %>%
   summarise(
     mean_profit = mean(player.round_payoff)
   )
  ) +
    geom_density(
    aes(
      x  = mean_profit,
      colour = as.factor(player.transport_cost),
      fill = as.factor(player.transport_cost),
      group = as.factor(player.transport_cost)
    ), alpha = .1
  ) +
  theme_bw()
```

Below, we have the distribution of all subperiod/round profits. Within each transport costs group, colors represent a single period. We see remarkably consistent distributions of profit within transport-cost groups, and noticeably different distributions between transport cost groups.




```{r, echo=FALSE, fig.height=3.5, fig.width=8}
ggplot(
 sesDat2p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  mutate(
    payoff = player.round_payoff * max(subsession.round_number) #deal with f'ing t=0.25...
  )
) +
    geom_density(
    aes(
      x  = payoff,
      colour = as.factor(player.period_number),
      fill = as.factor(player.period_number)
    ), alpha = .2
  ) + 
  theme(legend.position = "top") + 
  facet_grid(. ~player.transport_cost) 

```


Now, we see the distribution of profits over each transport costs, averaged over a given session+period (less granular than above).  

```{r, echo=FALSE, fig.height=3.5, fig.width=8}
ggplot(
  sesDat2p %>%
    group_by(session.code,player.transport_cost) %>%
    group_by(session.code, participant.code, player.transport_cost,player.period_number) %>% 
    summarise(
      mean_profit = mean(player.round_payoff * max(subsession.round_number)) 
    ) %>%
    filter(
      !is.na(mean_profit)
    )
) +
    geom_density(
    aes(
      x  = mean_profit,
      colour = as.factor(player.period_number),
      fill = as.factor(player.period_number)
    ), alpha = .1
  ) + 
  theme(legend.position = "top") + 
  facet_grid(. ~player.transport_cost)
```



To summarize a little: 

- The lower the transport cost the lower the profit to the subject. 

- There is a clear and likely statistically significant difference between average payoffs (our proxy for cooperation rates) between low transport cost `t = 0.1` and high `t = 1.0`.

- The difference between `t = 1.0` and `t = 0.75` does not yet appear to be significant. 


### Period Effect

There does not appear to be any period effect. I suspected that perhaps in later periods we'd see consistently lower or higher levels of cooperations/payoffs. That does not appear to be the case

```{r, echo=FALSE, fig.height=3.5, fig.width=8}
ggplot(
  sesDat2p %>%
    group_by(session.code, participant.code, player.transport_cost,player.period_number) %>% 
    summarise(
      mean_profit = mean(player.round_payoff * 20)
    ) %>%
    filter(
      !is.na(mean_profit),
      player.transport_cost != 0.25
    )
) +
    geom_boxplot(
    aes(
      x = as.factor(player.period_number),
      y = mean_profit
    ), alpha = .3
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.period_number),
      y = mean_profit
    ), alpha = .7
  )
```



## Prices and Transport Costs

How do prices related to transport cost? 
How does price stickiness related to transport cost?


The figure below plots prices for each session. This averages payoffs over all subject in all periods within one transport cost treatment group. 

- The violen shows the distribution of prices within that transport cost treatment group. 
- The grey ribben shows the first and third quartile of prices, that is, 50\% of all prices selected by subjects in the treatment group were within the ribbin. 
- The line shows the median for each transport cost treatment group. 

We see a generally positive relationship between prices and transport costs. 

```{r, echo=FALSE}

ggplot(
  sesDat2p %>%
    group_by(player.transport_cost) %>%
    summarise(
      price_q75 = quantile(player.price, 0.75),
      price_q50 = quantile(player.price, 0.5),
      price_q25 = quantile(player.price, 0.25),
      mean_price = mean(player.price)
    ) 
) +
    geom_violin(
    data = sesDat2p,
    aes(
      x = player.transport_cost,
      y = player.price,
      group = player.transport_cost
    ),
    alpha = 0.3,
    color = "grey70"
  ) +
  geom_ribbon(
    aes(
      x = (player.transport_cost),
      ymax = price_q75,
      ymin = price_q25
    ),
    alpha = .2
  ) +
  geom_line(
    aes(
      x = player.transport_cost,
      y = price_q50
    )
  ) +
  scale_x_continuous(
    breaks = c(0.1, 0.25, 0.5, 0.75, 1.0)
  )


```

Note that the transport cost of 0.25 had an error in its implementation. In 0.25 transport cost periods, subjects only had 5 subperiods, not the 20 all other periods had. This most likely explains the odd result. 


In the table below I compare average price between transport cost treatments, at the session level.

The standard errors are probably not the way you want to do it. I'm using every observation from each subperiod of each period. We probably want to compare average payoffs per period or per session. But still...



```{r, echo = F, eval = T, tidy = T}
df = sesDat2p %>%
  ungroup() %>%
  group_by(player.transport_cost) %>%
  mutate(
    player.round_price = player.price
  ) %>%
  summarise(
    n=n(),
    mean_price = mean(player.price),  
    median_price = median(player.price),
    se_price = sd(player.price)/(n)^0.5
  ) 

kable(
  format = "markdown", 
  df,  align = c("c")
  # col.names = c("","","","Avg Task 1 RET Score","Avg Task 2 RET Score","Avg Task 3 RET Score","Tourn", "Ss")
)
```

Prices in the `t = 1.0` transport cost treatment were on average $0.1761979$ or $39.15$\% higher compared to `t = 0.1`. 

Now, below, we calculate standard error with mean prices at the session+period+transport cost level. 

There are far fewer observations, making our standard error much larger. However, still, the very low transport cost are significantly different from the two transport costs in the high range. 

```{r, echo = F, eval = T, tidy = T}
df = sesDat2p %>%
  ungroup() %>%
  group_by(session.code, player.transport_cost, player.period_number) %>% 
  mutate(
    player.price = player.price 
  ) %>%
  summarise(
    n=n(),
    mean_price = mean(player.price),  
    median_price = median(player.price),
    se_price = sd(player.price)/(n)^0.5
  )

df = df %>%
  group_by(player.transport_cost) %>%
  summarise(
    n=n(),
    se_price = sd(mean_price)/(n)^0.5,
    mean_price = mean(mean_price)
  )

kable(
  format = "markdown", 
  df,  align = c("c")
  # col.names = c("","","","Avg Task 1 RET Score","Avg Task 2 RET Score","Avg Task 3 RET Score","Tourn", "Ss")
)
```



```{r, echo=FALSE}
ggplot(
 sesDat2p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
   summarise(
     mean_price = mean(player.price)
   )
) +
    geom_violin(
    aes(
      x = as.factor(player.transport_cost),
      y = mean_price
    ), alpha = .8
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.transport_cost),
      y = mean_price,
      color = player.period_number
    ), 
    alpha = .7,
    width = .1, height = 0
  ) +
  theme_bw()
```

Comparing prices in `t = 0.1` and `t = 1.0` (see below), there appears to be a statistically significant difference. 

- A t test comparing prices between min and max transport costs. Prices are average price at the session, participant, and period level. P-value 0.000029.
- A MW rank sum test comparing prices between min and max transport costs. Prices are average price at the session, participant, and period level. P-value 0.0002061.

```{r, echo=FALSE}
df =  sesDat2p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
   summarise(
     mean_price = mean(player.price)
   )
with(df, t.test(mean_price[player.transport_cost == 0.1], mean_price[player.transport_cost == 1.0]))
with(df, wilcox.test(mean_price[player.transport_cost == 0.1], mean_price[player.transport_cost == 1.0]))

## How many obs for eadch transport cost + period do we have?
# df %>%
#   group_by(player.transport_cost) %>%
#   summarise(n = n())
```


Summary of relationship between transport costs and prices. There is a relationship between prices and transport cost treatments. In higher transport cost settings subjects tended to have higher prices. 


## Price Stickiness and Transport Costs

Considering price stickiness as: 

- standard deviation of prices.
- average change in price when prices were changed. 
- at the session, round, player level, average number of times player changes prices between rounds. 


Looking at the standard deviation of prices (below), there does not appear to be a strong relationship between price variation and transport cost. 

```{r, echo=FALSE}


df =  sesDat2p %>%
  ungroup() %>%
  # group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  group_by(session.code,participant.code,player.period_number) %>%
   summarise(
     mean_price = mean(player.price),
     price_sd = sd(player.price)
   )


ggplot(
 sesDat2p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
   summarise(
     mean_price = mean(player.price),
     price_sd = sd(player.price)
   )
) +
    geom_violin(
    aes(
      x = as.factor(player.transport_cost),
      y = price_sd
    ), alpha = .8
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.transport_cost),
      y = price_sd,
      color = player.period_number
    ), 
    alpha = .7,
    width = .1, height = 0
  ) +
  theme_bw() +
  labs(
    title = "Price Standard Deviation and Transport Cost",
    subtitle = "One dot is one subject's price sd in one period, at this transport cost.",
    y = "Price Standard Deviation",
    x = "Transport Cost",
    color = "Period Number"
  )
```




Below, we look at the magnitutde of changes in price between subperiods. One dot represents the average price change (in absolute value) for one player, in one period. There does not appear to be a significant relationship between this measure of price stickiness and transport cost treatment. 

```{r, echo=FALSE}

df =  sesDat2p %>%
  ungroup() %>%
  # group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  group_by(session.code,participant.code,player.period_number,player.transport_cost) %>%
  arrange(participant._round_number) %>%
   mutate(
     price_chg = player.price - lag(player.price)
   ) %>%
  summarise(
    price_mean_chg = mean(price_chg, na.rm = T),
    price_mean_chg_abs = mean(abs(price_chg), na.rm = T)
  )


ggplot(
  df
) +
  geom_violin(
    aes(
      x = as.factor(player.transport_cost),
      y = price_mean_chg_abs
    ), alpha = .8
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.transport_cost),
      y = price_mean_chg_abs,
      color = player.period_number
    ), 
    alpha = .7,
    width = .1, height = 0
  ) +
  theme_bw() +
  labs(
    title = "Average Change in Price Between Rounds and Transport Cost",
    subtitle = "One dot is one subject's average price change (absolute value) in one period, at this transport cost.",
    y = "Average Change in Price Between Rounds",
    x = "Transport Cost",
    color = "Period Number"
  )
```


Below, we see the percent of times subjects change price between subperiods. As a reminder, each period is divided into a number of subperiods. If a subject does nothing with his or her experiment controls between subperiods, prices remain unchanged. Subjects must actively click to change prices between subperiods. 

The percent plotted below indicated the percent of times subjects change their price between periods. A score of zero indicated the subject never changed prices. A score of 100% indicates that person changes prices between every subperiod. 

Again, we see weak evidence that prices are slightly more sticky in high transport cost settings. 

```{r, echo=FALSE}

df =  sesDat2p %>%
  ungroup() %>%
  # group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  group_by(session.code,participant.code,player.period_number,player.transport_cost) %>%
  arrange(participant._round_number) %>%
   mutate(
     price_chg = as.numeric(!player.price == lag(player.price))
   ) %>%
  summarise(
    price_mean_chg = mean(price_chg, na.rm = T) * 100
  )


ggplot(
  df
) +
  geom_violin(
    aes(
      x = as.factor(player.transport_cost),
      y = price_mean_chg
    ), 
    alpha = .8
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.transport_cost),
      y = price_mean_chg,
      color = player.period_number
    ), 
    alpha = .7,
    width = .1, height = 0
  ) +
  theme_bw() +
  labs(
    title = "Frequency of Price Change and Transport Cost",
    subtitle = "One dot is one subject's percent of subperiods in which prices change in one period. ",
    y = "Percent of Unchanged Prices",
    x = "Transport Cost",
    color = "Period Number"
  )

df %>%
  group_by(player.transport_cost) %>%
  summarise(
    n = n(),
    price_chr_prct_mean = mean(price_mean_chg),
    price_chr_prct_median = median(price_mean_chg)
    
  )
```

----

# Four-Player Game

## Profit and Transport Cost

Keep in mind, where the max score one could earn in the two-player game is 0.5 (if both players go to the Pareto superior equilibrium, or in the unlikely event that one player is at the max price and the other undercuts him at `price = 0.5`), in the four player game the max score one could get, I think, is 0.25. This price occurs were all players have the highest price possible. 
	
It is possible that some players do earn above 0.25 if, in the unlikely event that they manage to undercut other players for many subperiods in the very-low transport cost world.



How player profits relate to transport cost at the very high, session level?

A very clear story, I think. The figure below plots average payoffs for each session. This averages payoffs over all subject in all periods within one session. 

```{r, echo=FALSE}
ggplot(
  sesDat4p %>%
    group_by(session.code,player.transport_cost,player.transport_cost) %>%
    summarise(
      mean_profit = mean(player.round_payoff * 20)
    ) %>%
    filter(
      !is.na(mean_profit)
    )
) +
  geom_point(
    aes(
      x = as.factor(player.transport_cost),
      y = mean_profit,
      color = paste(session.code,player.transport_cost)
    )
  )
```


```{r, echo = F, eval = T, tidy = T}
df = sesDat4p %>%
  ungroup() %>%
  group_by(player.transport_cost) %>%
  summarise(
    n=n(),
    mean_profit = mean(player.round_payoff * 20),  
    median_profit = median(player.round_payoff * 20),
    se_profit = sd(player.round_payoff * 20)/(n)^0.5

  ) 

kable(
  format = "markdown", 
  df,  align = c("c")
  # col.names = c("","","","Avg Task 1 RET Score","Avg Task 2 RET Score","Avg Task 3 RET Score","Tourn", "Ss")
)
```

The standard errors in the table above are likely way too generous. Below, the same table, but only averaging over subject+period+transport-cost. 

If things hold up, we'd get a statistically significant difference between 0.1 and 1.0, and possibly between smaller increments of transport cost. 

```{r, echo = F, eval = T, tidy = T}
df = sesDat4p %>%
  ungroup() %>%
  group_by(session.code, player.transport_cost, player.period_number) %>% 
  summarise(
    n=n(),
    mean_profit = mean(player.round_payoff * 20),  
    median_profit = median(player.round_payoff * 20),
    se_profit = sd(player.round_payoff * 20)/(n)^0.5
  ) %>%
  group_by(player.transport_cost) %>%
  summarise(
    n=n(),
    mean_profit_ = mean(mean_profit), 
    se_profit = sd(mean_profit)/(n)^0.5
  )


kable(
  format = "markdown", 
  df,  align = c("c")
  # col.names = c("","","","Avg Task 1 RET Score","Avg Task 2 RET Score","Avg Task 3 RET Score","Tourn", "Ss")
)
```


Now, looking at the very granular subject, period level, 

```{r, echo=FALSE}
ggplot(
  sesDat4p %>%
    group_by(session.code,player.transport_cost) %>%
    group_by(session.code, participant.code, player.transport_cost,player.period_number) %>% 
    summarise(
      mean_profit = mean(player.round_payoff * max(subsession.round_number))
    ) %>%
    filter(
      !is.na(mean_profit)
    )
) +
    geom_violin(
    aes(
      x = as.factor(player.transport_cost),
      y = mean_profit
    ), alpha = .3
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.transport_cost),
      y = mean_profit,
      color = player.period_number
    ), alpha = .7
  )
```

Looking more closely at the distributions, (below) we see;

- basically, the `t = 0.1` was profitless for subjects. 

- the `t = 0.25` world was pretty close to unprofitable. 

- the `t = 0.75` and `t = 1.0` worlds were consistently in the profitable range. 

The distributions here are derived from a player's final score in the period. 

```{r, echo=FALSE, fig.height=3.5, fig.width=8}
ggplot(
  sesDat4p %>%
    group_by(session.code,player.transport_cost) %>%
    group_by(session.code, participant.code, player.transport_cost,player.period_number) %>% 
    summarise(
      payoff = mean(player.round_payoff * max(subsession.round_number)) 
    )
) +
    geom_density(
    aes(
      x  = payoff,
      colour = as.factor(player.period_number),
      fill = as.factor(player.period_number)
    ), alpha = .2
  ) + 
  theme(legend.position = "top") + 
  facet_grid(. ~player.transport_cost) 

```

Below, looking at these distrubtions with a more grandular view. Here we look at all observations of all payoffs, including those within a period. 

It more clearly shows that in all of these worlds, people do spend a lot of time at zero payoffs. 

I drop `t = 0.1` because they are basically all at zero payoffs. 

```{r, echo=FALSE, fig.height=3.5, fig.width=8}
ggplot(
 sesDat4p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  mutate(
    payoff = player.round_payoff * max(subsession.round_number) #deal with f'ing t=0.25...
  ) %>%
   filter(player.transport_cost > 0.1)
) +
    geom_density(
    aes(
      x  = payoff,
      colour = as.factor(player.period_number),
      fill = as.factor(player.period_number)
    ), alpha = .2
  ) + 
  theme(legend.position = "top") + 
  facet_grid(. ~player.transport_cost) +
  coord_cartesian(xlim=c(0, .25))

```

## Prices and Transport Costs

How do prices related to transport cost? 
How does price stickiness related to transport cost?


The figure below plots prices for each session. This averages payoffs over all subject in all periods within one transport cost treatment group. 

- The violen shows the distribution of prices within that transport cost treatment group. 
- The grey ribben shows the first and third quartile of prices, that is, 50\% of all prices selected by subjects in the treatment group were within the ribbin. 
- The line shows the median for each transport cost treatment group. 

We see a generally positive relationship between prices and transport costs. 

```{r, echo=FALSE}

ggplot(
  sesDat4p %>%
    group_by(player.transport_cost) %>%
    summarise(
      price_q75 = quantile(player.price, 0.75),
      price_q50 = quantile(player.price, 0.5),
      price_q25 = quantile(player.price, 0.25),
      mean_price = mean(player.price)
    ) 
) +
    geom_violin(
    data = sesDat2p,
    aes(
      x = player.transport_cost,
      y = player.price,
      group = player.transport_cost
    ),
    alpha = 0.3,
    color = "grey70"
  ) +
  geom_ribbon(
    aes(
      x = (player.transport_cost),
      ymax = price_q75,
      ymin = price_q25
    ),
    alpha = .2
  ) +
  geom_line(
    aes(
      x = player.transport_cost,
      y = price_q50
    )
  ) +
  scale_x_continuous(
    breaks = c(0.1, 0.25, 0.5, 0.75, 1.0)
  )


```


In the table below I compare average price between transport cost treatments, at the session level.

The standard errors are probably not the way you want to do it. I'm using every observation from each subperiod of each period. We probably want to compare average payoffs per period or per session. But still...



```{r, echo = F, eval = T, tidy = T}
df = sesDat4p %>%
  ungroup() %>%
  group_by(player.transport_cost) %>%
  mutate(
    player.round_price = player.price
  ) %>%
  summarise(
    n=n(),
    mean_price = mean(player.price),  
    median_price = median(player.price),
    se_price = sd(player.price)/(n)^0.5
  ) 

kable(
  format = "markdown", 
  df,  align = c("c")
  # col.names = c("","","","Avg Task 1 RET Score","Avg Task 2 RET Score","Avg Task 3 RET Score","Tourn", "Ss")
)
```

Prices in the `t = 1.0` transport cost treatment were on average $0.146$ or $85.82$\% higher compared to `t = 0.1`. 

Now, below, we calculate standard error with mean prices at the session+period+transport cost level. 

There are far fewer observations, making our standard error much larger. However, still, the very low transport cost are significantly different from the two transport costs in the high range. 

```{r, echo = F, eval = T, tidy = T}
df = sesDat4p %>%
  ungroup() %>%
  group_by(session.code, player.transport_cost, player.period_number) %>% 
  mutate(
    player.price = player.price 
  ) %>%
  summarise(
    n=n(),
    mean_price = mean(player.price),  
    median_price = median(player.price),
    se_price = sd(player.price)/(n)^0.5
  )

df = df %>%
  group_by(player.transport_cost) %>%
  summarise(
    n=n(),
    se_price = sd(mean_price)/(n)^0.5,
    mean_price = mean(mean_price)
  )

kable(
  format = "markdown", 
  df,  align = c("c")
  # col.names = c("","","","Avg Task 1 RET Score","Avg Task 2 RET Score","Avg Task 3 RET Score","Tourn", "Ss")
)
```



```{r, echo=FALSE}
ggplot(
 sesDat4p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
   summarise(
     mean_price = mean(player.price)
   )
) +
    geom_violin(
    aes(
      x = as.factor(player.transport_cost),
      y = mean_price
    ), alpha = .8
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.transport_cost),
      y = mean_price,
      color = player.period_number
    ), 
    alpha = .7,
    width = .1, height = 0
  ) +
  theme_bw()
```

Comparing prices in `t = 0.1` and `t = 1.0` (see below), there appears to be a statistically significant difference. 

- A t test comparing prices between min and max transport costs. Prices are average price at the session, participant, and period level. P-value 0.0000002285.
- A MW rank sum test comparing prices between min and max transport costs. Prices are average price at the session, participant, and period level. P-value 4.458e-10.

```{r, echo=FALSE}
df =  sesDat4p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
   summarise(
     mean_price = mean(player.price)
   )
with(df, t.test(mean_price[player.transport_cost == 0.1], mean_price[player.transport_cost == 1.0]))
with(df, wilcox.test(mean_price[player.transport_cost == 0.1], mean_price[player.transport_cost == 1.0]))

## How many obs for eadch transport cost + period do we have?
df %>%
  group_by(player.transport_cost) %>%
  summarise(n = n())
```


Summary of relationship between transport costs and prices. There is a relationship between prices and transport cost treatments. In higher transport cost settings subjects tended to have higher prices. 




## Price Stickiness and Transport Costs

Considering price stickiness as: 

- standard deviation of prices.
- average change in price when prices were changed. 
- at the session, round, player level, average number of times player changes prices between rounds. 


Looking at the standard deviation of prices (below), there does not appear to be a strong relationship between price variation and transport cost. 

```{r, echo=FALSE}


df =  sesDat4p %>%
  ungroup() %>%
  # group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  group_by(session.code,participant.code,player.period_number) %>%
   summarise(
     mean_price = mean(player.price),
     price_sd = sd(player.price)
   )


ggplot(
 sesDat2p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
   summarise(
     mean_price = mean(player.price),
     price_sd = sd(player.price)
   )
) +
    geom_violin(
    aes(
      x = as.factor(player.transport_cost),
      y = price_sd
    ), alpha = .8
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.transport_cost),
      y = price_sd,
      color = player.period_number
    ), 
    alpha = .7,
    width = .1, height = 0
  ) +
  theme_bw() +
  labs(
    title = "Price Standard Deviation and Transport Cost",
    subtitle = "One dot is one subject's price sd in one period, at this transport cost.",
    y = "Price Standard Deviation",
    x = "Transport Cost",
    color = "Period Number"
  )
```




Below, we look at the magnitutde of changes in price between subperiods. One dot represents the average price change (in absolute value) for one player, in one period. There does not appear to be a significant relationship between this measure of price stickiness and transport cost treatment. 

```{r, echo=FALSE}

df =  sesDat4p %>%
  ungroup() %>%
  # group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  group_by(session.code,participant.code,player.period_number,player.transport_cost) %>%
  arrange(participant._round_number) %>%
   mutate(
     price_chg = player.price - lag(player.price)
   ) %>%
  summarise(
    price_mean_chg = mean(price_chg, na.rm = T),
    price_mean_chg_abs = mean(abs(price_chg), na.rm = T)
  )


ggplot(
  df
) +
  geom_violin(
    aes(
      x = as.factor(player.transport_cost),
      y = price_mean_chg_abs
    ), alpha = .8
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.transport_cost),
      y = price_mean_chg_abs,
      color = player.period_number
    ), 
    alpha = .7,
    width = .1, height = 0
  ) +
  theme_bw() +
  labs(
    title = "Average Change in Price Between Rounds and Transport Cost",
    subtitle = "One dot is one subject's average price change (absolute value) in one period, at this transport cost.",
    y = "Average Change in Price Between Rounds",
    x = "Transport Cost",
    color = "Period Number"
  )

df %>%
  group_by(player.transport_cost) %>%
  summarise(
    n = n(),
    price_mean_chg_abs_sd = sd(price_mean_chg_abs),
    price_mean_chg_abs = mean(price_mean_chg_abs)
  )

```


Below, we see the percent of times subjects change price between subperiods. As a reminder, each period is divided into a number of subperiods. If a subject does nothing with his or her experiment controls between subperiods, prices remain unchanged. Subjects must actively click to change prices between subperiods. 

The percent plotted below indicated the percent of times subjects change their price between periods. A score of zero indicated the subject never changed prices. A score of $100$\% indicates that person changes prices between every subperiod. 

Again, we see weak evidence that prices are slightly more sticky in high transport cost settings. 

```{r, echo=FALSE}

df =  sesDat4p %>%
  ungroup() %>%
  # group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  group_by(session.code,participant.code,player.period_number,player.transport_cost) %>%
  arrange(participant._round_number) %>%
   mutate(
     price_chg = as.numeric(!player.price == lag(player.price))
   ) %>%
  summarise(
    price_mean_chg = mean(price_chg, na.rm = T) * 100
  )


ggplot(
  df
) +
  geom_violin(
    aes(
      x = as.factor(player.transport_cost),
      y = price_mean_chg
    ), alpha = .8
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.transport_cost),
      y = price_mean_chg,
      color = player.period_number
    ), 
    alpha = .7,
    width = .1, height = 0
  ) +
  theme_bw() +
  labs(
    title = "Frequency of Price Change and Transport Cost",
    subtitle = "One dot is one subject's percent of subperiods in which prices change in one period. ",
    y = "Percent of Unchanged Prices",
    x = "Transport Cost",
    color = "Period Number"
  )

df %>%
  group_by(player.transport_cost) %>%
  summarise(
    n = n(),
    price_chr_prct_mean = mean(price_mean_chg),
    price_chr_prct_median = median(price_mean_chg)
    
  )
```



-----------

## Period Effect

The period affect, if present, is dominated by transport costs all being the same at certain periods.

```{r, echo=FALSE, fig.height=3.5, fig.width=8}
ggplot(
  sesDat4p %>%
    group_by(session.code, participant.code, player.transport_cost,player.period_number) %>% 
    summarise(
      mean_profit = mean(player.round_payoff * 20)
    ) %>%
    filter(
      !is.na(mean_profit),
      player.transport_cost != 0.25
    )
) +
    geom_boxplot(
    aes(
      x = as.factor(player.period_number),
      y = mean_profit
    ), alpha = .3
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.period_number),
      y = mean_profit
    ), alpha = .7
  )
```


# Comparing the two-player game to four-player

First off note that in the two-player game, the most you can possible earn is 0.5. In the four-player game if all players set prices at their max they would each earn 0.25. 

---

--**Dave**: These results look great. So, it looks like we have pretty robust results for one of our hypotheses (transport costs and profits (mark-ups) from these pilots. The other questions are mostly to do with how the results change for the 2p vs. 4p games. If it's relatively easy, could you generate those same plots, but where you stack the 2p and 4p images on top of each other so it's easier to visually compare? Right now I'm trying to scroll back and forth to compare and it's not working too well! --


## Period Profit and Transport Cost

```{r, echo=FALSE}

df =  sesDat2p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  mutate(
    player.round_payoff = player.round_payoff * max(subsession.round_number) #deal with f'ing t=0.25...
  ) %>%
   summarise(
     mean_profit = mean(player.round_payoff)
   ) %>%
  mutate(
    NumPlayers = "two-players"
  )

df = bind_rows(
  df, 
  (  sesDat4p %>%
       group_by(session.code,player.transport_cost) %>%
       group_by(session.code, participant.code, player.transport_cost,player.period_number) %>% 
       summarise(
         mean_profit = mean(player.round_payoff * max(subsession.round_number))
       ) %>%
       filter(
         !is.na(mean_profit)
       ) %>%
       mutate(
         NumPlayers = "four-players"
       )
  )
)

df2 = df %>%
  group_by(
    player.transport_cost, NumPlayers
  ) %>%
  summarise(
    mean_profit = mean(mean_profit)
  )

ggplot(
 df
) +
    geom_violin(
    aes(
      x = (player.transport_cost),
      y = mean_profit,
      group = player.transport_cost
    ), alpha = .8
  ) +
  geom_jitter(
    aes(
      x = (player.transport_cost),
      y = mean_profit,
      color = player.period_number
    ), 
    alpha = .3,
    width = .05, height = 0
  ) +
  geom_line(
    data = df2,
    aes(
      y = (mean_profit), 
      x = (player.transport_cost))
  ) +
  facet_grid(NumPlayers~.) +
  theme_bw()




```

## Price Standard Deviation and Transport Cost

```{r, echo=FALSE}


df =  sesDat2p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  mutate(
    player.round_payoff = player.round_payoff * max(subsession.round_number) #deal with f'ing t=0.25...
  ) %>%
   summarise(
     mean_price = mean(player.price),
     price_sd = sd(player.price)
   ) %>%
  mutate(
    NumPlayers = "two-players"
  )

df = bind_rows(
  df,
  sesDat4p %>%
  ungroup() %>%
  group_by(session.code,participant.code,player.transport_cost,player.period_number) %>%
   summarise(
     mean_price = mean(player.price),
     price_sd = sd(player.price)
   ) %>%
    mutate(NumPlayers = "four-players")
) 


ggplot(
 df
) +
    geom_violin(
    aes(
      x = as.factor(player.transport_cost),
      y = price_sd
    ), alpha = .8
  ) +
  geom_jitter(
    aes(
      x = as.factor(player.transport_cost),
      y = price_sd,
      color = player.period_number
    ), 
    alpha = .3,
    width = .1, height = 0
  ) +
  facet_grid(NumPlayers~.) +
  theme_bw() +
  labs(
    title = "Price Standard Deviation and Transport Cost",
    subtitle = "One dot is one subject's price sd in one period, at this transport cost.",
    y = "Price Standard Deviation",
    x = "Transport Cost",
    color = "Period Number"
  ) 
```

## Price Stickiness

**Dave**: On price stickiness. I was thinking more along the lines of "price responsiveness" I suppose. i.e. that price are less responsive to shocks (changes in transport costs) in the 2p sessions. We could run the same regression above, but with price, but I think we should get the same result, since profit essentially equals price here (not exactly, of course). This is related to price stickiness because if prices are less responsive, for whatever reason, monetary policy will have a greater impact. I guess I'm less interested in the within round movements in price, I just sort of view that as experimentation. One thing that I think may be interesting is to look at how price changes change as rounds go on. i.e. do the changes become less extreme later in a period and does this vary across transport costs. Again, the metrics on price stickiness you create and think are interesting, but could you do them for a 2p vs. 4p comparison? I think that comparison is much more interesting. I think we should keep the transport cost ones, but I'd also like to add the 2p vs. 4p comparison.

```{r, echo=FALSE}

df =  sesDat2p %>%
  ungroup() %>%
  group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
  summarise(
    price = mean(player.price),
    price_median = median(player.price),
    twoPlayer = 1,
    playerNum = "Two Players"
  )

df = bind_rows(
  df, 
  sesDat4p %>%
    ungroup() %>%
    group_by(session.code, participant.code, player.transport_cost,player.period_number) %>%
    summarise(
    price = mean(player.price),
    price_median = median(player.price),
      twoPlayer = 0,
      playerNum = "Four Players"
    )
) %>%
  dplyr::filter(
    player.transport_cost != 0.25
  ) %>%
  group_by(playerNum) %>%
  dplyr::mutate(
    sd_price = sd(price),
    stdz_price = price / sd_price
  )



p1= ggplot(
  df,
  aes(
    x = player.transport_cost,
    y = log(price),
    group = playerNum,
    color = playerNum
  )
) +
  geom_jitter(
    width = 0.07,
    alpha = .4) +
  geom_smooth(
    method = 'lm'
  ) +
  theme_bw()
p1



reg = lm(
  log(price) ~ log(player.transport_cost) + twoPlayer + twoPlayer:log(player.transport_cost),
  df
)

summary(reg)
```

Similar results to log-log with profit and transport costs. 


And with normalized price, 

```{r, echo=FALSE}
reg = lm(
  stdz_price ~ log(player.transport_cost) + twoPlayer + twoPlayer:log(player.transport_cost),
  df
)

summary(reg)
```

The results is now insignificant. 


---


## Sustained joint profits. 

As a measure or indication of collusion, here we use the situation in which both players have profitable positions.

There are other explainations for both players having positive profits where they are not colluding. For example, if they are attempting to undercut their competitor but accidentially allow them a profit. High transport costs also limit the ability for competitors to undercut others. 

The following table shows the percent of the subperiod in which all players had at positive payoffs. We  see a clear relationship between transport cost and firms ability to maintain joint positive profits. 

```{r, echo=FALSE, fig.height=3.5, fig.width=8}

# 2 player

df = full_join(
  sesDat2p %>%
  ungroup() %>%
  arrange(session.code, group.id_in_subsession, player.period_number, subsession.round_number) %>%
  group_by(session.code, player.period_number) %>%
  mutate(
    max_roundnumber = max(subsession.round_number),
    payoff = player.round_payoff * max(subsession.round_number)
  ) %>%
  select(
    session.code, group.id_in_subsession, 
    player.period_number, subsession.round_number, player.transport_cost,
    player.loc, player.price
  ) %>%
  mutate(
    player.loc = paste("price_",player.loc, sep="")
  ) %>%
  spread(player.loc, player.price),
  sesDat2p %>%
  ungroup() %>%
  arrange(session.code, group.id_in_subsession, player.period_number, subsession.round_number) %>%
  group_by(session.code, player.period_number) %>%
  mutate(
    max_roundnumber = max(subsession.round_number),
    payoff = player.round_payoff * max(subsession.round_number)
  ) %>%
  select(
    session.code, group.id_in_subsession, 
    player.period_number, subsession.round_number, player.transport_cost,
    player.loc, payoff
  ) %>%
  mutate(
    player.loc = paste("payoff_",player.loc, sep="")
  ) %>%
  spread(player.loc, payoff),
  by = c("session.code", "group.id_in_subsession", "player.period_number", "subsession.round_number", "player.transport_cost")
)

df = df %>%
  ungroup() %>%
  mutate(
    payoff_diff = abs(payoff_0.75 - payoff_0.25),
    payoff_bothpos = ifelse(payoff_0.75 == 0 | payoff_0.25 == 0, FALSE, TRUE)
  )

df_2p = df %>%
  group_by(player.transport_cost) %>%
  summarize(
    mean_jointPosProfits = mean(payoff_bothpos)
  ) %>%
  mutate(
    players = 2
  ) %>%
  select(player.transport_cost, players, mean_jointPosProfits)

# four player
df = full_join(
  sesDat4p %>%
  ungroup() %>%
  arrange(session.code, group.id_in_subsession, player.period_number, subsession.round_number) %>%
  group_by(session.code, player.period_number) %>%
  mutate(
    max_roundnumber = max(subsession.round_number),
    payoff = player.round_payoff * max(subsession.round_number)
  ) %>%
  select(
    session.code, group.id_in_subsession, 
    player.period_number, subsession.round_number, player.transport_cost,
    player.loc, player.price
  ) %>%
  mutate(
    player.loc = paste("price_",player.loc, sep="")
  ) %>%
  spread(player.loc, player.price),
  sesDat4p %>%
  ungroup() %>%
  arrange(session.code, group.id_in_subsession, player.period_number, subsession.round_number) %>%
  group_by(session.code, player.period_number) %>%
  mutate(
    max_roundnumber = max(subsession.round_number),
    payoff = player.round_payoff * max(subsession.round_number)
  ) %>%
  select(
    session.code, group.id_in_subsession, 
    player.period_number, subsession.round_number, player.transport_cost,
    player.loc, payoff
  ) %>%
  mutate(
    player.loc = paste("payoff_",player.loc, sep="")
  ) %>%
  spread(player.loc, payoff),
  by = c("session.code", "group.id_in_subsession", "player.period_number", "subsession.round_number", "player.transport_cost")
)

df = df %>%
  ungroup() %>%
  mutate(
    payoff_bothpos = ifelse(payoff_0.125 == 0 |payoff_0.375 == 0 |payoff_0.625 == 0 | payoff_0.875 == 0, FALSE, TRUE)
  )

df_4p = df %>%
  group_by(player.transport_cost) %>%
  summarize(
    mean_jointPosProfits = mean(payoff_bothpos)
  ) %>%
  mutate(
    players = 4
  ) %>%
  select(player.transport_cost, players, mean_jointPosProfits)


df = bind_rows(df_4p, df_2p)

kable(
  format = "markdown", 
  df,  align = c("c")
  # col.names = c("","","","Avg Task 1 RET Score","Avg Task 2 RET Score","Avg Task 3 RET Score","Tourn", "Ss")
)

```

Below, I am curious how payoffs evolved as periods progressed. Were they stable, or did they tend to decline? 

The plots below show the distributions of payoffs over the period. The x-axis is the subperiod, the y-axis the flow payoff. 

There are jittered poits and violins to show distributions. The line shows the median over all observations in this group. 

It's hard to see, but in the two-player game, the distributions of profits are remarkably consistent between subperiods in `t = 0.5, 0.75 and 1.0`.



```{r, echo=FALSE, fig.height=5, fig.width=8}

ggplot(
  bind_rows(
    sesDat2p %>% mutate(player = "2player"), 
    sesDat4p %>% mutate(player = "4player")
  ) %>%
    group_by(player.transport_cost, session.code, player.period_number) %>%
    mutate(
      payoff = ifelse(
        player == "4player",
        player.round_payoff * 20,
        player.cumulative_round_payoff)
    ),
  aes(
    x = subsession.round_number, 
    y = payoff
  )
) +
  geom_violin(aes(group = subsession.round_number)) +
  geom_jitter(alpha = 0.1) +
  geom_line(
    data =   bind_rows(
    sesDat2p %>% mutate(player = "2player"), 
    sesDat4p %>% mutate(player = "4player")
  ) %>%
    group_by(player.transport_cost, player,subsession.round_number) %>%
    mutate(
      payoff = ifelse(
        player == "4player",
        player.round_payoff * 20,
        player.cumulative_round_payoff)
    ) %>%
    summarise(payoff_mean = median(payoff)),
  aes(y = payoff_mean)) +
  facet_grid( player ~ player.transport_cost) +
  theme_bw()


# df = bind_rows(df_4p, df_2p)


```

## Distribution of price changes. 

One indication of collusion is stable actions. 










---- 

*This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code.*

```{r, echo=F, results='asis'}

cat(
  " Compiled by Curtis Kephart, curtis.kephart@nyu.edu, ",
  as.character(Sys.time())," GMT, ",
  Sys.timezone(location = TRUE),
  sep = ""
)
```